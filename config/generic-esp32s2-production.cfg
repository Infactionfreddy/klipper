# Production-ready configuration for ESP32-S2
# Xtensa single-core @ 240MHz
# Flash: 4MB | RAM: 320KB | GPIO: 0-46
# Features: WiFi, USB OTG, 2x DAC, Touch sensors
# NO Bluetooth!

[mcu]
serial: /dev/ttyACM0  # USB CDC (native USB)
baud: 250000
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 15
max_z_accel: 100

# ========================================
# STEPPER CONFIGURATION
# ========================================
[stepper_x]
step_pin: GPIO1
dir_pin: GPIO2
enable_pin: !GPIO3
microsteps: 16
rotation_distance: 40
endstop_pin: ^GPIO9
position_endstop: 0
position_max: 220
homing_speed: 50

[stepper_y]
step_pin: GPIO4
dir_pin: GPIO5
enable_pin: !GPIO6
microsteps: 16
rotation_distance: 40
endstop_pin: ^GPIO10
position_endstop: 0
position_max: 220
homing_speed: 50

[stepper_z]
step_pin: GPIO7
dir_pin: !GPIO8
enable_pin: !GPIO11
microsteps: 16
rotation_distance: 8
endstop_pin: ^GPIO12
position_endstop: 0.5
position_max: 250
position_min: -2

[extruder]
step_pin: GPIO13
dir_pin: GPIO14
enable_pin: !GPIO15
microsteps: 16
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: GPIO16
sensor_type: EPCOS 100K B57560G104F
sensor_pin: GPIO1  # ADC1_CH0
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
min_temp: 0
max_temp: 265
min_extrude_temp: 170
max_extrude_only_distance: 150.0

# ========================================
# HEATED BED
# ========================================
[heater_bed]
heater_pin: GPIO21
sensor_type: EPCOS 100K B57560G104F
sensor_pin: GPIO2  # ADC1_CH1
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

# ========================================
# FANS (PWM via LEDC)
# ========================================
[fan]
pin: GPIO33
max_power: 1.0
kick_start_time: 0.5
off_below: 0.1

[heater_fan hotend_fan]
pin: GPIO34
max_power: 1.0
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# ========================================
# OPTIONAL: DAC OUTPUT (ESP32-S2 only!)
# ESP32-S2 has 2x 8-bit DAC on GPIO17/GPIO18
# ========================================
#[output_pin dac_output_1]
#pin: GPIO17
#pwm: False
#value: 0.5  # 0-1.0 = 0-3.3V
#
#[output_pin dac_output_2]
#pin: GPIO18
#pwm: False
#value: 0.0

# ========================================
# BED LEVELING (Optional)
# ========================================
[bltouch]
sensor_pin: ^GPIO38
control_pin: GPIO39
x_offset: -44
y_offset: -6
z_offset: 2.3
speed: 5
samples: 2
sample_retract_dist: 3.0

[safe_z_home]
home_xy_position: 154, 116
speed: 50
z_hop: 10
z_hop_speed: 5

[bed_mesh]
speed: 120
horizontal_move_z: 5
mesh_min: 15, 15
mesh_max: 175, 195
probe_count: 5, 5
algorithm: bicubic

# ========================================
# SAFETY FEATURES
# ========================================
[verify_heater extruder]
max_error: 120
check_gain_time: 20
hysteresis: 5
heating_gain: 2

[verify_heater heater_bed]
max_error: 120
check_gain_time: 60
hysteresis: 5
heating_gain: 2

# ========================================
# GPIO NOTES FOR ESP32-S2
# ========================================
# Safe output pins: GPIO1-18, 21, 33-42
# USB pins: GPIO19/GPIO20 (DO NOT USE)
# Strapping pins (avoid): GPIO0, 45, 46
# Flash reserved: GPIO26-32 (DO NOT USE)
# ADC1 pins: GPIO1-10 (recommended for analog)
# ADC2 pins: GPIO11-20 (avoid with WiFi)
# DAC pins: GPIO17, GPIO18 (8-bit 0-3.3V)
# Touch sensors: GPIO1-14
# RTC pins: GPIO0-21 (for deep sleep wakeup)
