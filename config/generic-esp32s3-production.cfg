# Production-ready configuration for ESP32-S3
# Xtensa dual-core @ 240MHz
# Flash: 4MB+ | RAM: 512KB | GPIO: 0-48
# Features: WiFi, Bluetooth LE, USB OTG, AI acceleration
# NO DAC (use PWM instead)

[mcu]
serial: /dev/ttyACM0  # USB CDC (native USB)
baud: 250000
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 15
max_z_accel: 100

# ========================================
# STEPPER CONFIGURATION
# ========================================
[stepper_x]
step_pin: GPIO1
dir_pin: GPIO2
enable_pin: !GPIO42
microsteps: 16
rotation_distance: 40
endstop_pin: ^GPIO3
position_endstop: 0
position_max: 220
homing_speed: 50

[stepper_y]
step_pin: GPIO4
dir_pin: GPIO5
enable_pin: !GPIO6
microsteps: 16
rotation_distance: 40
endstop_pin: ^GPIO7
position_endstop: 0
position_max: 220
homing_speed: 50

[stepper_z]
step_pin: GPIO8
dir_pin: !GPIO9
enable_pin: !GPIO10
microsteps: 16
rotation_distance: 8
endstop_pin: ^GPIO11
position_endstop: 0.5
position_max: 250
position_min: -2

[extruder]
step_pin: GPIO12
dir_pin: GPIO13
enable_pin: !GPIO14
microsteps: 16
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: GPIO21
sensor_type: EPCOS 100K B57560G104F
sensor_pin: GPIO1  # ADC1_CH0
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
min_temp: 0
max_temp: 265
min_extrude_temp: 170
max_extrude_only_distance: 150.0

# ========================================
# HEATED BED
# ========================================
[heater_bed]
heater_pin: GPIO47
sensor_type: EPCOS 100K B57560G104F
sensor_pin: GPIO2  # ADC1_CH1
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

# ========================================
# FANS (PWM via LEDC)
# ========================================
[fan]
pin: GPIO48
max_power: 1.0
kick_start_time: 0.5
off_below: 0.1

[heater_fan hotend_fan]
pin: GPIO38
max_power: 1.0
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# ========================================
# PWM DAC EMULATION (ESP32-S3 has NO DAC!)
# Use high-frequency PWM for analog output
# ========================================
[output_pin pwm_dac_1]
pin: GPIO17
pwm: True
hardware_pwm: True
cycle_time: 0.000100  # 10kHz PWM (smooth analog approximation)
value: 0.5  # 0-1.0 simulates 0-3.3V

[output_pin pwm_dac_2]
pin: GPIO18
pwm: True
hardware_pwm: True
cycle_time: 0.000100
value: 0.0

# ========================================
# BED LEVELING (Optional)
# ========================================
[bltouch]
sensor_pin: ^GPIO15
control_pin: GPIO16
x_offset: -44
y_offset: -6
z_offset: 2.3
speed: 5
samples: 2
sample_retract_dist: 3.0

[safe_z_home]
home_xy_position: 154, 116
speed: 50
z_hop: 10
z_hop_speed: 5

[bed_mesh]
speed: 120
horizontal_move_z: 5
mesh_min: 15, 15
mesh_max: 175, 195
probe_count: 5, 5
algorithm: bicubic

# ========================================
# SAFETY FEATURES
# ========================================
[verify_heater extruder]
max_error: 120
check_gain_time: 20
hysteresis: 5
heating_gain: 2

[verify_heater heater_bed]
max_error: 120
check_gain_time: 60
hysteresis: 5
heating_gain: 2

# ========================================
# DISPLAY (Optional - SPI)
# ========================================
# SPI LCD on GPIO35/GPIO36/GPIO37
#[display]
#lcd_type: uc1701
#spi_bus: spi2
#cs_pin: GPIO35
#dc_pin: GPIO36
#rst_pin: GPIO37

# ========================================
# GPIO NOTES FOR ESP32-S3
# ========================================
# Safe output pins: GPIO1-21, 33-48
# USB pins: GPIO19/GPIO20 (use for USB CDC)
# Strapping pins (avoid): GPIO0, 45, 46
# Flash reserved: GPIO26-32 (DO NOT USE)
# ADC1 pins: GPIO1-10 (recommended for analog)
# ADC2 pins: GPIO11-20 (avoid with WiFi)
# NO DAC - use high-freq PWM instead!
# RTC pins: GPIO0-21 (for deep sleep wakeup)
# 
# IMPORTANT: GPIO26-32 are RESERVED for flash/PSRAM
# ESP32-S3 can have up to 48 GPIOs depending on module
